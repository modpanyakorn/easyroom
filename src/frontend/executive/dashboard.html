<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="dashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS (‡∏û‡∏£‡πâ‡∏≠‡∏° Popper.js) -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
    <title>Dashboard</title>
</head>

<body>
    <div id="sidebar-container"></div>
    <div class="main-content overflow-auto vh-100">
        <div class="container">
            <div class="card blue" onclick="window.location.href='detailroom.html'">
                <div>
                    <h3 style="font-weight: normal; opacity: 0.9;">Most Booking Room</h3>
                    <p id="room-name" style="font-weight:bolder; font-size: 20px;">Loading...</p>
                    <!-- <canvas id='pointLineCardChart1' style='width: 80px; height: 100px;'></canvas> -->
                </div>
            </div>

            <div class="card sky">
                <div onclick="window.location.href='broken_equipment.html'">
                    <h3 style="font-weight: normal; opacity: 0.9;">Most Brokend Equipment</h3>
                    <p id="equipment-name" style="font-weight: bold; font-size: large;">Loading...</p>
                    <!-- <canvas id='pointLineCardChart2' ></canvas> -->
                </div>
            </div>
            <div class="card yellow" onclick="window.location.href='graphdetail.html'">
                <div>
                    <h3 style="font-weight: normal; opacity: 0.9;">Most Time Used</h3>
                    <p id="time" style="font-weight:bolder; font-size: 16px;">Loading...</p>
                    <!-- <canvas id='pointLineCardChart3' ></canvas> -->
                </div>
            </div>
            <div class="card red">
                <div onclick="window.location.href='student.html'">
                    <h3 style="font-weight: normal; opacity: 0.9;">Most Department</h3>
                    <p id="department-name">Loading...</p>
                    <!-- <canvas id='pointLineCardChart4' ></canvas> -->
                </div>
            </div>
        </div>

        <div class="large-card" style="justify-content: center; align-items: center;">
            <h3>‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
            <div class="mb-3 text-center">
                <label for="roomFilter" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á:</label>
                <select id="roomFilter" class="form-select w-auto d-inline" onchange="filterRoom()">
                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option> <!-- Default: show all rooms -->
                    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° options ‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å JS -->
                </select>
            </div>
            <div class="chart-container" style="display: flex; justify-content: center; align-items: center;">
                <canvas id="barChart" style="height: 300px ; align-items: center;"></canvas>
            </div>
            <button class="details-btn" onclick="window.location.href='detailroom.html'">Details</button>
        </div>
        
        
        

        <div class="statistics-container">
            <div class="statistics-card">
                <h5>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏à‡∏≠‡∏á
                    <div class="dropdown d-inline">
                        <i class="bi bi-caret-down-fill" type="button" data-bs-toggle="dropdown" aria-expanded="false"
                            style="color: #929292; font-size: 10px;">
                        </i>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showChart('day')">‡∏ß‡∏±‡∏ô</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showChart('week')">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showChart('month')">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</a></li>
                            <li><a class="dropdown-item" href="#" onclick="showChart('year')">‡∏õ‡∏µ</a></li>
                        </ul>
                    </div>
                </h5>
                <div style=" width: 100%; height: 80%;display: flex;align-items: center;justify-content: center;">
                    <canvas id='pointLineChart' style=" width: 100% !important; height: 100% !important;"></canvas>

                </div>
                <!-- <canvas id="bookingChart"></canvas> -->
                <button class="details-btn" onclick="window.location.href='graphdetail.html'">Details</button>
            </div>

            <div class="statistics-card">
                <h5 style="text-align: center;">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                    <div class="dropdown d-inline">
                        <i class="bi bi-caret-down-fill" type="button" data-bs-toggle="dropdown" aria-expanded="false"
                            style="color: #929292; font-size: 10px;">
                        </i>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showDoughnutChart(2)">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</a>
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="showDoughnutChart(1)">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏¢‡∏∑‡∏°</a></li>
                        </ul>
                    </div>
                </h5>
                <!-- <img src="Insert graph.jpg" alt="‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏Å‡∏£‡∏≤‡∏ü" width="250" height="250"><br> -->
                <div class="chart-container"
                    style=" width: 100%;height: 80%;display: flex; align-items: center;justify-content: center;">
                    <canvas id="doughnutChart2" style="width: 80%;"
                        onclick="window.location.href='broken_equipment.html'"></canvas>
                    <canvas id="doughnutChart1" style="display: none; width: 80%;"
                        onclick="window.location.href='borrow_equipment.html'"></canvas>
                </div>
                <button class="details-btn" onclick="window.location.href='eqiup.html'">Details</button>
            </div>

            <div class="statistics-card">
                <h6 style="text-align: center;">‡∏ô‡∏¥‡∏™‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h6>
                <section style="margin-top: 40px;">
                    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó -->
                    <div class="filters">
                        <label for="room">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á:</label>
                        <select id="room" name="room">
                            <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å API -->
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>  <!-- ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
                        </select>
                        
                        <label for="role">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:</label>
                        <select id="role" name="role">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="student">‡∏ô‡∏¥‡∏™‡∏¥‡∏ï</option>
                            <option value="teacher">‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</option>
                        </select>
                        
                        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏á -->
                        <button onclick="applyFilters()">‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                    
                    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
                    <section id="userList">
                        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                    </section>
                    
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
                    <button class="details-btn" onclick="window.location.href='student.html'">Details</button>
                </section>
            </div>
            
            
            <div class="statistics-card">
                <h6 style="text-align: center;">‡∏ô‡∏¥‡∏™‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h6>

                <div style="margin-top: 20px; text-align: center;">
                    <label for="roleFilter">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:</label>
                    <select id="roleFilter">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="student">‡∏ô‡∏¥‡∏™‡∏¥‡∏ï</option>
                        <option value="teacher">‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</option>
                    </select>

                    <button onclick="loadTopReporters()" style="margin-left: 10px;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>

                <section id="ReportList" style="margin-top: 20px;"></section>

                <button class="details-btn" onclick="window.location.href='reporttable.html'">Details</button>
            </div>

        </div>

    </div>
</body>
<script src="../script/auth.js"></script>
<script src="../script/config.js"></script>
<script src="script/dashboard.js"></script>
<script>
    fetch("sidebar.html")
        .then((resp) => resp.text())
        .then((html) => {
            // ‡πÅ‡∏ó‡∏£‡∏Å Sidebar ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
            document.getElementById("sidebar-container").innerHTML = html;
        })
        .then(() => {
            // ‡πÉ‡∏´‡πâ Highlight ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            const btnStats = document.getElementById("btnStatistic");
            btnStats.classList.add("btn-sidebar-active");
        })
        .catch((err) => console.error("Failed to load sidebar:", err));

    function loadTopReporters() {
        const role = document.getElementById("roleFilter").value;
        let url = `${window.CONFIG.API_URL}/executive/mostreport`;

        if (role) {
            url += `?role=${role}`;
        }

        fetch(url)
            .then(response => response.json()) // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON
            .then(data => {
                const userList = document.getElementById("ReportList");
                userList.innerHTML = "";  // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

                if (data.length === 0) {
                    userList.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>";
                    return;
                }

                data.forEach(user => {
                    const div = document.createElement("div");
                    div.className = "split-container";
                    div.innerHTML = `<p>${user.name}</p> <p>${user.stat} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>`;
                    userList.appendChild(div);
                });
            })
            .catch(error => {
                console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
                document.getElementById("ReportList").innerHTML = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ";
            });
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    document.addEventListener("DOMContentLoaded", () => {
        loadTopReporters();
    });

    let barChart = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
let rooms = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å API

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function loadRooms() {
  fetch(`${window.CONFIG.API_URL}/executive/mostroomalldata`)
    .then(response => response.json())
    .then(data => {
      rooms = data.map(item => item.room_id); // ‡πÄ‡∏Å‡πá‡∏ö room_id ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const roomFilter = document.getElementById('roomFilter');

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° option ‡πÉ‡∏ô dropdown
      rooms.forEach(roomId => {
        const option = document.createElement('option');
        option.value = roomId;
        option.textContent = `SC2-${roomId}`; // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
        roomFilter.appendChild(option);
      });

      filterRoom(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    })
    .catch(err => console.error('Error loading room list:', err));
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
function filterRoom() {
  const roomId = document.getElementById('roomFilter').value;
  const filteredData = roomId ? rooms.filter(room => room === roomId) : rooms;

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≤‡∏Å API ‡πÇ‡∏î‡∏¢‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á
  fetch(`${window.CONFIG.API_URL}/executive/mostroomalldata?room_id=${roomId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("Fetched Data:", data); // üõ† Debug: ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• API
      renderBarChart(data);
    })
    .catch(error => {
      console.error('Error fetching data:', error);
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderBarChart ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
function renderBarChart(data) {
  const barCtx = document.getElementById('barChart').getContext('2d');
  if (!barCtx) {
    console.error("‚ùå Canvas element not found!");
    return;
  }

  // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß, ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏°‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
  if (barChart) {
    barChart.destroy();
  }

  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
  const labels = data.map(item => `SC2-${item.room_id}`);
  const totalCount = data.map(item => item.total_count);
  const csCount = data.map(item => item.cs_count);
  const itCount = data.map(item => item.it_count);

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà
  barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏¥‡∏™‡∏¥‡∏ï‡∏£‡∏ß‡∏°',
          data: totalCount,
          backgroundColor: '#E5D2BA'
        },
        {
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏¥‡∏™‡∏¥‡∏ï ‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡∏Ø',
          data: csCount,
          backgroundColor: '#E54715'
        },
        {
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏¥‡∏™‡∏¥‡∏ï ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏Ø',
          data: itCount,
          backgroundColor: '#622BBE',
          padding: {
            top: 10,
            bottom: 30
          }
        }
      ]
    },
    options: {
      responsive: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            font: {
              size: 16
            }
          }
        },
        title: {
          display: true,
          text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏¥‡∏™‡∏¥‡∏ï',
          font: {
            size: 14
          }
        }
      },
      scales: {
        x: {
          ticks: {
            font: {
              size: 16
            }
          }
        },
        y: {
          beginAtZero: true,
          ticks: {
            callback: function (value) {
              return Math.floor(value);
            },
            font: {
              size: 14
            }
          }
        }
      }
    }
  });
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°
window.addEventListener('DOMContentLoaded', () => {
  loadRooms(); // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á
});



</script>

</html>